<!DOCTYPE html>
<!--
Bobby Nyotta - June 2013 - OrganJet
This file is the main web application. This takes a zip code and finds the nearest kidney transplant centers.
-->
<html>
  <head>
    <title>Organ Jet</title>
    <link href="bootstrap.css" rel="stylesheet" type="text/css">
    <link href="bootstrap-responsive.css" rel="stylesheet" type="text/css">
    <link href="style.css" rel="stylesheet" type="text/css">
  
    <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyC8ndKa5KGrRbe6feO4v4M2dODOw8w5_Q0&sensor=false"></script>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.10.1/jquery.min.js"></script>
    <script src="google-spreadsheet-util.js"></script>
    <script src="retrieve-data-hardcoded.js"></script>
    <!--<script src="retrieve-data.js"></script> -->
        
    <!-- Conflict b/w Bootstrap and Google Maps Info window styles problem, so this fixes it! -->
    <style type="text/css">
      img[src*="gstatic.com/"], img[src*="googleapis.com/"] { max-width: none; }
    </style>
    
    <script>
    // declare global variables
    var oLow = new Array()
        ,oAll = new Array()
        ,oKid = new Array()
        ,zip_obj = new Object()
        ,bounds = new google.maps.LatLngBounds()
        ,markersArray = []
        ,url_srt = 'http://maps.googleapis.com/maps/api/geocode/json?address='
        ,url_end = '&sensor=false'
        ,destIconL = 'https://chart.googleapis.com/chart?chst=d_map_pin_letter&chld=L|63D1F4|000000'
        ,destIconR = 'https://chart.googleapis.com/chart?chst=d_map_pin_letter&chld=R|12f404|000000'
        ,destIconC = 'https://chart.googleapis.com/chart?chst=d_map_pin_letter&chld=C|FFAA00|000000'
        ,originIcon = 'https://chart.googleapis.com/chart?chst=d_map_spin&chld=.75|0|FFFF00|11|_|O'
        ,numOfLoc = 5;
    var map
        ,geocoder; 
        
    // creates map
    function initialize() {
      var opts = {
        center: new google.maps.LatLng(39.8282, -98.5795), //center of america
        zoom: 4,
        mapTypeId: google.maps.MapTypeId.ROADMAP
      };
      map = new google.maps.Map(document.getElementById('map-canvas'), opts);
      geocoder = new google.maps.Geocoder();
    }
    
    // returns closest 5 locations from each list and puts it into the table
    function calculateDistances(z) {
      getCoordFromZip(z);

      setTimeout(function () { // give getCoordFromZip() 1 second to execute
        if ( zip_obj.sta != null ) {
          deleteOverlays();
          //console && console.log(zip_obj.loc+','+zip_obj.lat+','+zip_obj.lng);
          addMarker(zip_obj.lat, zip_obj.lng, 'o','Zip Code: ' + z);
          
          // find haversine distance b/w each low wait tx and zip
          for (var j = 0; j < ListLow.length; j++) {
            var tmp=new Object();
            tmp.name= ListLow[j].name;
            tmp.add = ListLow[j].add;
            tmp.lng = ListLow[j].lng;
            tmp.lat = ListLow[j].lat;
            tmp.web = ListLow[j].web;
            tmp.dist_num=haversine(zip_obj.lng,zip_obj.lat,ListLow[j].lng,ListLow[j].lat);
            oLow.push(tmp);
          }
          
          // find haversine distance b/w each regular tx and zip
          for (var j = 0; j < ListAll.length; j++) {
            var tmp=new Object();
            tmp.name= ListAll[j].name;
            tmp.add = ListAll[j].add;
            tmp.lng = ListAll[j].lng;
            tmp.lat = ListAll[j].lat;
            tmp.web = ListAll[j].web;
            tmp.dist_num=haversine(zip_obj.lng,zip_obj.lat,ListAll[j].lng,ListAll[j].lat);
            oAll.push(tmp);
            // console && console.log(tmp.dist_num );
          }
          
          // find haversine distance b/w each regular tx and zip
          for (var j = 0; j < ListKid.length; j++) {
            var tmp=new Object();
            tmp.name= ListKid[j].name;
            tmp.add = ListKid[j].add;
            tmp.lng = ListKid[j].lng;
            tmp.lat = ListKid[j].lat;
            tmp.web = ListKid[j].web;
            tmp.dist_num=haversine(zip_obj.lng,zip_obj.lat,ListKid[j].lng,ListKid[j].lat);
            oKid.push(tmp);
            // console && console.log(tmp.dist_num );
          }
          
          var oLow_Sort = oLow.sort(function(a,b) { return parseFloat(a.dist_num) - parseFloat(b.dist_num) } );
          var oAll_Sort = oAll.sort(function(a,b) { return parseFloat(a.dist_num) - parseFloat(b.dist_num) } );
          var oKid_Sort = oKid.sort(function(a,b) { return parseFloat(a.dist_num) - parseFloat(b.dist_num) } );

          for(var i=0; i<numOfLoc; i++) {
            var tbody = $('#results-table tbody');
            tbody.append("<tr><td>" + parseInt(i+1) + "</td><td><a href=" + oLow_Sort[i].web + " target='_blank'>" + oLow_Sort[i].name + "</a></td><td>" + oLow_Sort[i].add + "</td><td><a href=" + oAll_Sort[i].web + " target='_blank'>" + oAll_Sort[i].name + "</a></td><td>" + oAll_Sort[i].add + "</td><td><a href=" + oKid_Sort[i].web + " target='_blank'>" + oKid_Sort[i].name + "</a></td><td>" + oKid_Sort[i].add + "</td></tr>");
            addMarker(oLow_Sort[i].lat, oLow_Sort[i].lng, 'l', oLow_Sort[i].name);
            addMarker(oAll_Sort[i].lat, oAll_Sort[i].lng, 'r', oAll_Sort[i].name);
            addMarker(oKid_Sort[i].lat, oKid_Sort[i].lng, 'c', oKid_Sort[i].name);
            // console && console.log(oLow_Sort[i].dist_num + ' ' + oAll_Sort[i].dist_num + ' ' + oKid_Sort[i].dist_num);
          }
          map.fitBounds(bounds); //zoom based on the LatLngBounds object
          
          var thead = $('#results-table thead');
          thead.append("<tr><th class='num'>No.</th><th class='loc'>Low Wait Time Transplant Center</th><th class='address'>Address</th><th class='loc'>Regular Transplant Center</th><th class='address'>Address</th><th class='loc'>Children's Transplant Center</th><th class='address'>Address</th></tr>");
          description();
        }
      },1000);
    }
    
    // adds markers to the map
    function addMarker(lat, lng, isDestination, info) {
      var icon;
      if (isDestination == 'l') {        // low-wait
        icon = destIconL;
      } else if (isDestination == 'r') { // regular
        icon = destIconR;
      } else if (isDestination == 'c') { // children's center
        icon = destIconC;
      } else {                           // zip code
        icon = originIcon;
      }
      // add markers using lat/lng
      var marker = new google.maps.Marker({
        map: map,
        position: new google.maps.LatLng(lat, lng), 
        icon: icon,
        title: info
      });
      
      // add pop-up window to markers that works on click
      marker.infowindow = new google.maps.InfoWindow({
        content: info
      });
      google.maps.event.addListener(marker, 'click', function() {
        marker.infowindow.open(map, marker);
      });
      
      markersArray.push(marker); // add marker to array
      bounds.extend(new google.maps.LatLng(lat, lng)); // add marker location to bounds object (for zoom)
    }
    
    // clears map of pins; clears table and text
    function deleteOverlays() {
      oLow = new Array();
      oAll = new Array();
      oKid = new Array();
      bounds = new google.maps.LatLngBounds();
      $('#results-table thead').empty();
      $('#results-table tbody').empty();
      $('#description').empty();
      $('#disclaimer').empty();
      for (var i = 0; i < markersArray.length; i++) {
        markersArray[i].setMap(null);
      }
      markersArray = [];
    }
    
    // Computes the Haversince distance between two points
    function haversine(lon1, lat1, lon2, lat2) {
      var R = 3958.7558657440545 // miles
        ,dLat = toRad(lat2-lat1)
        ,dLon = toRad(lon2-lon1)
        ,lat1 = toRad(lat1)
        ,lat2 = toRad(lat2);
 
      var a = Math.sin(dLat/2) * Math.sin(dLat/2) +
              Math.sin(dLon/2) * Math.sin(dLon/2) * Math.cos(lat1) * Math.cos(lat2); 
      var c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a)); 
      return R * c;
    }
    
    // Converts numeric degrees to radians
    function toRad(Value) {
      return Value * Math.PI / 180;
    }
    
    // All of the text that comes below the results table is in here. This is not dynamic at all.
    function description() {
      var descrip = $('#description');
      descrip.append("<p>We have provided the five closest kidney transplant locations with lowest median wait times along with five closest regular and children's transplant centers:</p>");
      descrip.append("<ul><li>Yellow Pin - Location of Your Zip Code</li><li>Blue Pin - Locations of the closest low wait time transplant centers</li><li>Green Pin - Locations of the closest regular transplant centers</li><li>Orange Pin - Locations of the closest children's transplant centers</li></ul>");
      descrip.append("<br />The transplant center locations were obtained from <a href='http://www.srtr.org' target='_blank'>Scientific Registry of Transplant Recipients</a>.");
      descrip.append("<br />If a geographically close transplant center is also a low wait time transplant center, it will only show up in the 'Low Wait Time' column.");
      //descrip.append("<p></p>The map in this application is supported by Google Maps Javascript API V3, which has strict usage limits. Querying too many zip codes in a short period of time can cause the application to fail. If this happens, refresh the page.");
      descrip.append("<br />This application was developed and tested with Mozilla Firefox 22.0 and Google Chrome 28.0. For best results, use these browsers and enable JavaScript. We are working on fully supporting other web browsers across various devices.");
      var disclaim = $('#disclaimer');
      disclaim.append("<br />OrganJet and GuardianWings do not provide medical advice. All information presented here is for educational/awareness purposes only. Please consult your physician before taking any action. Every effort has been made to furnish accurate and most up to date summarized data based on publicly available information.");
    }
    
    // Returns the longitude and latitude from a zip code
    // Also contains some validation
    function getCoordFromZip(z) {
      geocoder.geocode( { 'address': z}, function(results, status) {
        if (status != "OK") { // make sure zip code is valid
          zip_obj.lng=null;
          zip_obj.lat=null;
          zip_obj.loc=null;
          zip_obj.sta=null;
          alert("The Zip Code Entered Is Unknown. Try The Zip Code Again Or Try A Different Zip Code.");
        } else if (results[0].formatted_address.search("USA") === -1) { // make sure zip code is in the USA
          zip_obj.lng=null;
          zip_obj.lat=null;
          zip_obj.loc=null;
          zip_obj.sta=null;
          alert("The Zip Code Entered Is Not in the USA. Try A Different Zip Code.");
        } else {
          zip_obj.lng=results[0].geometry.location.lng();
          zip_obj.lat=results[0].geometry.location.lat();
          zip_obj.loc=results[0].formatted_address;
          zip_obj.sta=status;
        }
      });
    }
    
    google.maps.event.addDomListener(window, 'load', initialize);
    
    </script>
  </head>
  
  <body>
    <h3 class="offset1">Find a Kidney Transplant Center with a Low Wait Time</h3>
    <div class='row map-container'>
      <div class="span10 offset1" id="map-canvas"></div>
    </div>
    <div class='row'>
      <div class="span6 offset3">
        <p>
          <form id="zipForm">
            Enter Your Zip Code: <input id="zip" name="zip" type="text" maxlength="5"/>
            <input id="execButton" name="buttonExecute" type="button" value="Find" class='btn' />
          </form> 
        </p>
      </div>
    </div>
    <div class='row'>
      <div class="span10 offset1">
        <table id="results-table" class='table table-striped table-bordered table-hover table-condensed'>
          <thead></thead>
          <tbody></tbody>
        </table>
      </div>
    </div>
    <div class='row'>
      <div class="span10 offset1 well">
        <p id="description"></p>
        <p id="disclaimer"></p>
      </div>
    </div>
    
    <script>
      //catch the keydown event when #zip has the focus
      function validateZipInput(z) {
        if (z.length < 5) {
          alert("Zip Code Must Be 5 Digits");
          return false;
        } else if (z.match(/^[0-9]+$/) == null) {
          alert("Zip Code Can Only Contain Digits");
          return false;
        } else {
          return true;
        }
      }

      $("#zipForm").submit(function() {
        var zip = $('#zip').val();
        if (validateZipInput(zip)) {
          calculateDistances(zip);
        }
        return false;
      })
      
      $('#execButton').on("click", function(){
        var zip = $('#zip').val();
        if (validateZipInput(zip)) {
          calculateDistances(zip);
        }
      })
    </script>
    
  </body>
</html>
